#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Date  : 2025/6/20 10:02
# @File  : tools.py.py
# @Author: johnson
# @Contact : github: johnson7788
# @Desc  :

from google.adk.tools import ToolContext
from google.adk.tools.agent_tool import AgentTool
import time
from datetime import datetime
import random

# 模拟数据库存储的文档
Documents = [
"""
## 📰 近期电动车新闻精选

1. **美国参议院确认：** 共和党无法通过预算调整废除 USPS 运营的 7,200 辆 EV，USPS 投资约 10 亿美元，目标到 2028 年增至 66,000 辆([reuters.com][1], [reuters.com][2])。

2. **民调转向冷却：** AP-NORC 调查显示，美国民主党对 EV 税收抵免支持率从 2022 年的 70% 降至 58%，独立选民从 49% 降至 28%([apnews.com][3])。

3. **消费意愿下降：** Shell 调查发现欧洲有 41% 驾驶者计划购买 EV（↓7%，年降），美国为 31%（↓3%），费用和基础设施仍是主要障碍([reuters.com][4])。

4. **销售预期下调：** BloombergNEF 将 2030 年 U.S. EV 占比预期从 48% 下调至 27%，IEA 全球预测也从 42 M 降至 39 M，但预计 2025 年全球 EV 销量将达 22 M([axios.com][5])。

5. **美国制造占比提升：** Cars.com 指出 2025 年美国本土制造排名前十的车型中，EV 占多数（前 4 名为 Tesla），但政策不确定和价格上升带来挑战([marketwatch.com][6])。

6. **车主担忧故障率：** 英国调查指出，11%的 EV 车主两年内遇无法行驶问题，比汽油车略高。EV 拖车率 40.6%，远超汽油车的 29.6%([thesun.ie][7])。

7. **欧盟市场增速放缓：** 欧洲首季度 EV 销量涨 28%，占英国市场 20.4%，但宽松排放目标可能削弱长期发展([ft.com][8])。

8. **中国主导全球 EV：** 2025 年中国 EV 年销量超过 1100 万，占全球销量一半以上；BYD 超越 Tesla，份额分别为 16% vs 14%([theaustralian.com.au][9])。

9. **印度 EV 渗透上升：** 2025 年 5 月 EV 在印度乘用车中的占比达到 4.1%，较去年同期 2.6% 明显提升。

10. **加拿大补贴断档：** 加拿大因联邦 EV 补贴资金枯竭，Ford 加拿大 CEO 表示 2025 初 EV 销售“像石头一样暴跌”([finance.yahoo.com][10])。

11. **英国充电网络不足：** 英国承诺投资 £1.4 B 发展充电网，但厂家批评政策执行滞后，家庭用户获取充电设施仍有难度。

12. **印度城市充电扩张：** 印度 Nashik 正建设 10 个 EV 充电站，提升城市充电基础设施，目标覆盖更多电动两/四轮车([timesofindia.indiatimes.com][11])。

---

## 📊 核心统计数据汇总

| 指标           | 数值                                     | 时间        | 来源                  |
| ------------ | -------------------------------------- | --------- | ------------------- |
| 全球 EV 总量     | 约 4,000 万辆                             | 2023 年底   | IEA ([iea.org][12]) |
| 2023 年 EV 销量 | \~1,400 万辆（同比 +35%）                    | 2023 全年   | IEA                 |
| EV 占全球新车销售   | 18%（2023），22%（2024）                    | IEA/OWID  |                     |
| 中国新能源汽车产销    | 2024 年产销约 1,158 万辆，出口 128.4 万辆（产+40%）  | 年度        | Zhihu               |
| 中国新能源汽车保有量   | 3,140 万辆（纯电 2,209 万）                   | 2024 年末   | 中商/公安部              |
| 中国 EV 渗透率    | 新注册 41.8%，整体 8.9%                      | 2024 年末   | 同上                  |
| 中国 EV 产量突破   | 2024 产销量破 1,000 万辆，2018→2022→2024 加速扩张 | CCTV      |                     |
| 中国月销量领军车     | 吉利“星愿”（38,715辆），比亚迪“海鸥”（31,105辆）等      | 2025 5 月  | Modiauto            |

---

## 🔍 解读趋势与洞见

* **全球 EV 市场依旧高增长**：2023–24连续两年销量激增，2025年有望达 22 M 辆。
* **中国市场当属领头羊**：年销量超过 1100 万辆、保有量达 3140 万，产销规模全球最多。
* **欧美遇瓶颈**：欧洲和美国增长放缓，政策不确定与基础设施不足成为主因。
* **消费者态度分化**：支持率下滑、消费意愿疲软（特别是独立选民与欧洲用户），加上可靠性担忧增加。
* **政策与补贴成关键**：加拿大全额补贴用尽导致销售骤降；美欧税收激励与排放法规对行业影响重大。
* **基础设施短板显现**：英国和印度等国还在充电网络建设，而美欧对法规放松颇有争议。

""",
"""研究称在 20 年里，电池每年平均退化约 1.8%，意味着续航每年减少不到 2%。虽然算不上理想，但远不至于影响正常使用。如果期间没有重大故障，20 年后仍能保有 64% 的原始续航能力。这项分析基于超过 1 万辆电动车的数据样本。

当然，电动车电池并非完全不会出问题，但从统计上看，故障率极低。一项研究指出，过去十年内生产的电动车电池故障率不到 0.5%。

需要注意的是，电池衰退的速度并不均衡，也受地域环境影响。最明显的衰减发生在最初几年，随后趋于平缓，在电池接近使用寿命末期时再次加剧。炎热气候也会加速退化，因此尽量让电动车停在阴凉处，尤其是充电时。

当前的电动车配备了先进的冷却与加热系统来维持电池温度，但“保持低温优于高温”依然适用。这也涉及到直流快充问题 —— 相较于一级或二级慢充，快充确实会稍微加速电池退化。

对镍锰钴与镍钴锰电池（IT之家注：三元锂电池）来说，维持电量在 20% 到 80% 之间，有助于延长使用寿命；而对于磷酸铁锂电池，这一限制通常不适用。但研究表明，频繁充满磷酸铁锂电池也可能导致寿命缩短。

即使严格按照这些建议操作，也无法避免电池随时间自然衰退的现实。就像长时间未启动的汽油车也会出现软管老化、油泵损坏一样，电池也会在静置中缓慢失去部分容量。""",
"""IEA发布了“2025年全球电动汽车展望报告”。全球电动汽车销量持续创纪录，中国及其他新兴经济体表现突出。2024年全球电动汽车销量突破1700万辆，市场份额超过20%。亚洲和拉丁美洲新兴市场成为新增长中心，2024年销量激增60%，达到近60万辆——相当于五年前欧洲市场规模。

中国和欧洲引领预期增长，新兴经济同步激增

2025年全球电动汽车销量预计突破2000万辆，占全球汽车总销量1/4以上。在当前政策环境下，尽管前景存在不确定性，2030年电动汽车占比仍将超过40%。贸易与产业政策演变的不确定性、经济前景下行风险及油价下跌可能影响电动汽车普及率，但同样波及整体汽车市场。

全球电动汽车贸易增长，制造商瞄准新市场

中国保持全球电动汽车制造中心地位，产量占全球70%以上。2024年全球电动汽车贸易增长20%，进口量现已占全球销量近1/5。随着中国车企在巴西、墨西哥和东南亚取得进展，出口市场日趋多元化。

竞争加剧与电池降价提升可购性，但进展不均

2024年全球电池电动车均价下降，但与传统车的价差在许多市场依然存在。中国电动车型在新兴市场普遍低于均价，强化了产业竞争力。关键矿物价格走低和电池厂商竞争加剧推动2024年全球电池组价格下降，但降幅差异显著。

提升充电网络覆盖、容量与整合是普及关键

过去两年公共充电桩数量翻倍以匹配销量增长。充电容量是衡量公共网络完善度的重要指标。政府推动互操作性、标准化、智能充电及车网融合的政策有助于加速电动化转型。

电动卡车经济性改善，长途运输亦具潜力

2024年全球电动卡车销量增长近80%，占总销量近2%。在中国特定场景下，重型电动卡车全生命周期成本已低于柴油车型。强制卡车司机休息时间政策可有效降低途中充电的机会成本。""",
"""
一些可能用到的电动汽车的图片
2025年4月，全球纯电动车销量同比增长38%.
https://n.sinaimg.cn/spider20250610/598/w955h443/20250610/d5d4-b0eb5848953ded18fbc44aefb452923d.png

2025年4月，电动汽车中国同比增速51%
https://n.sinaimg.cn/spider20250610/663/w855h608/20250610/27b7-9119b6ad6f21a0fdd477e8736232bad2.png

美国2025年4月销量9.54万辆，同比下降4%
https://n.sinaimg.cn/spider20250610/560/w981h379/20250610/f372-46624c7063942fbca5f6f8a933128f9c.png

特斯拉2025年4月销量8.48万辆，同比下降17%
https://n.sinaimg.cn/spider20250610/473/w868h405/20250610/d80c-d608870a0938449e561f725bc00c169a.png

电动汽车卡通图片
https://n.sinaimg.cn/spider20250621/120/w1440h1080/20250621/f8d9-7d234d7b43fda7ec916d01fb81555bae.jpg

"""
]

async def DocumentSearch(
    keyword: str, number: int,
    tool_context: ToolContext,
):
    """
    根据关键词搜索文档
    :param keyword: str, 搜索的相关文档的关键词
    :param number: int, 搜索文档的数量
    :return: 返回每篇文档数据
    """
    agent_name = tool_context.agent_name
    print(f"Agent{agent_name}正在调用工具：DocumentSearch: " + keyword)
    metadata = tool_context.state.get("metadata", {})
    if metadata is None:
        metadata = {}
    print(f"调用工具：DocumentSearch时传入的metadata: {metadata}")
    print("文档检索: " + keyword)
    result = ""
    document_ids = []
    for i, doc in enumerate(Documents):
        result += f"# 文档id:{i}\n {doc}\n\n"
        document_ids.append(i)
    metadata["tool_document_ids"] = document_ids
    tool_context.state["metadata"] = metadata
    return result

if __name__ == '__main__':
    result = DocumentSearch(keyword="电动汽车")
    print(result)